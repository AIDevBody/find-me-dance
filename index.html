<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Swing Calendar Feed Builder</title>
  <!--
    This page lets you compose a tag-based calendar feed for the Swing
    community. It mirrors the look and feel of the original Swing Tag
    Builder but instead of outputting a simple list of hashtags, it
    generates a ready‚Äëto‚Äëuse iCalendar (ICS) feed URL. The feed URL
    points at your deployed Google Apps Script (see the README or your
    deployment settings) and includes query parameters for every tag
    you select. Multiple selections within a single category are joined
    with commas. Subscribe to the resulting link in your favourite
    calendar client (Google Calendar, Apple Calendar, Outlook, etc.) to
    automatically receive events that match the selected tags.
  -->
  <style>
    :root {
      --gap: 12px;
      --pad: 14px;
      --radius: 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    /* Constrain the width of the content on large screens */
    .container {
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
    }
    body {
      margin: 0;
      padding: 20px;
      background: #0b0f16;
      color: #eaf0ff;
    }
    a {
      color: #9bcbff;
    }
    header {
      margin-bottom: 22px;
    }
    .card {
      background: #121827;
      border: 1px solid #1f2a44;
      border-radius: var(--radius);
      padding: var(--pad);
      margin-bottom: var(--gap);
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--gap);
    }
    .group {
      border: 1px solid #233455;
      border-radius: var(--radius);
      padding: var(--pad);
    }
    .group h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: 600;
      color: #bcd1ff;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button,
    select {
      background: #1a2540;
      color: #eaf0ff;
      border: 1px solid #2a3f66;
      border-radius: 10px;
      padding: 8px 10px;
    }
    input[type="text"] {
      width: 100%;
      background: #0e1527;
      color: #eaf0ff;
      border: 1px solid #2a3f66;
      border-radius: 10px;
      padding: 10px;
    }
    .muted {
      color: #9fb3d9;
    }
    .footer {
      margin-top: 20px;
      font-size: 12px;
    }
    details {
      margin-top: 8px;
    }
    summary {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
  <header>
    <h1>üé∑ Swing Calendar Feed Builder</h1>
    <p class="muted">
      Select the tags that describe your interests and we'll build a
      personalised calendar feed. Subscribe to the generated URL in
      your calendar client to stay up to date with events that match
      your selections.
    </p>
  </header>

  <section class="card">
    <div class="controls">
      <label>Language:&nbsp;
        <select id="lang"></select>
      </label>
      <button id="copyLink">Copy link</button>
      <button id="clearAll">Clear all</button>
    </div>
    <details>
      <summary>Feed URL</summary>
      <div style="margin-top:8px;">
        <input id="feedUrl" type="text" readonly />
      </div>
    </details>
    <details>
      <summary>How to subscribe</summary>
      <div style="margin-top:8px;" class="muted">
        <p>Copy the Feed URL above and paste it into your calendar application's
        ‚Äúsubscribe to calendar‚Äù or ‚Äúadd by URL‚Äù dialog. Most calendar
        clients support the iCalendar format.</p>
      </div>
    </details>
  </section>

  <section id="groups" class="row"></section>

  <div class="footer muted">
    <p>
      This page uses a locally stored list of tags to build the feed URL. It
      does not contact any external servers until you subscribe to the URL.
    </p>
  </div>
  </div> <!-- end container -->

  <script>
  // Base URL of your deployed Google Apps Script Web App (see user instructions)
  const BASE_URL = 'https://script.google.com/macros/s/AKfycbwLZ7yudmpkonocViR2Ai1TRiuW9Q0ho2DsNHABA88sUVXazLOg1rTrnFCNTcknCwjEtQ/exec';

  // Localised UI strings for English and German.  These strings control
  // the visible text on the page (titles, buttons, labels, etc.).  If you
  // extend this page to support additional languages, add entries here.
  const uiStrings = {
    en: {
      title: 'üé∑ Swing Calendar Feed Builder',
      intro: 'Select the tags that describe your interests and we\'ll build a personalised calendar feed. Subscribe to the generated URL in your calendar client to stay up to date with events that match your selections.',
      language: 'Language:',
      copyLink: 'Copy link',
      clearAll: 'Clear all',
      feedUrlSummary: 'Feed URL',
      howToSummary: 'How to subscribe',
      howToText: 'Copy the Feed URL above and paste it into your calendar application\'s ‚Äúsubscribe to calendar‚Äù or ‚Äúadd by URL‚Äù dialog. Most calendar clients support the iCalendar format.',
      footer: 'This page uses a locally stored list of tags to build the feed URL. It does not contact any external servers until you subscribe to the URL.',
      all: 'All',
      none: 'None'
    },
    de: {
      title: 'üé∑ Swing Kalender-Feed-Generator',
      intro: 'W√§hle die Tags aus, die deine Interessen beschreiben, und wir erstellen einen personalisierten Kalender-Feed. Abonniere die erzeugte URL in deiner Kalender-App, um √ºber passende Veranstaltungen auf dem Laufenden zu bleiben.',
      language: 'Sprache:',
      copyLink: 'Link kopieren',
      clearAll: 'Alles l√∂schen',
      feedUrlSummary: 'Feed-URL',
      howToSummary: 'So abonnieren',
      howToText: 'Kopiere die oben angezeigte Feed-URL und f√ºge sie in das Dialogfeld ‚ÄûPer URL abonnieren‚Äú deiner Kalender‚ÄëApp ein. Die meisten Kalender unterst√ºtzen das iCalendar‚ÄëFormat.',
      footer: 'Diese Seite nutzt eine lokal gespeicherte Liste von Tags, um die Feed-URL zu erstellen. Es werden keine externen Server kontaktiert, bis du die URL abonnierst.',
      all: 'Alle',
      none: 'Keine'
    }
  };

  // Holds translated display names for each tag type (group labels).  This
  // mapping is populated asynchronously from tags/ui/tags_ui.csv on page load.
  let typeDisplay = {};

  // Fetch the tag UI CSV and build the typeDisplay map.  The CSV is expected
  // to have columns: tag_type, ui_type, display_en, display_de.  Any
  // additional languages can also be supported by adding more display_xx
  // columns.  Returns a promise that resolves when parsing is complete.
  async function loadTypeDisplay() {
    try {
      const res = await fetch('tags/ui/tags_ui.csv', { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load tag UI definitions');
      const text = await res.text();
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(',');
      const idxType = header.indexOf('tag_type');
      const langCols = {};
      header.forEach((h, i) => {
        const m = h.match(/^display_(.+)$/);
        if (m) langCols[m[1]] = i;
      });
      const map = {};
      for (let i = 1; i < lines.length; i++) {
        const parts = lines[i].split(',');
        const type = parts[idxType];
        if (!type) continue;
        map[type] = {};
        for (const lang in langCols) {
          map[type][lang] = parts[langCols[lang]] || type;
        }
      }
      typeDisplay = map;
    } catch (err) {
      console.error(err);
      // fallback: leave typeDisplay empty
    }
  }

  // Update all static texts on the page based on the current language
  function updateStaticText() {
    const langSel = document.getElementById('lang');
    const lang = langSel.value || 'en';
    const strings = uiStrings[lang] || uiStrings.en;
    // Header title and intro
    const h1 = document.querySelector('header h1');
    if (h1) h1.textContent = strings.title;
    const introP = document.querySelector('header p');
    if (introP) introP.textContent = strings.intro;
    // Language label
    const langLabel = document.querySelector('label[for="lang"]') || document.querySelector('label');
    if (langLabel) {
      // The label contains the text and a nbsp and the select element.  Update
      // only the text part before the nbsp.  To be safe, replace the first
      // child text node.
      const node = langLabel.childNodes[0];
      if (node && node.nodeType === Node.TEXT_NODE) {
        node.nodeValue = strings.language + ' ';
      }
    }
    // Buttons
    const copyBtn = document.getElementById('copyLink');
    if (copyBtn) copyBtn.textContent = strings.copyLink;
    const clearBtn = document.getElementById('clearAll');
    if (clearBtn) clearBtn.textContent = strings.clearAll;
    // Details summaries and text
    const details = document.querySelectorAll('details');
    if (details.length > 0) {
      // First details: feed URL summary
      const sum1 = details[0].querySelector('summary');
      if (sum1) sum1.textContent = strings.feedUrlSummary;
      // Second details: how to subscribe
      if (details.length > 1) {
        const sum2 = details[1].querySelector('summary');
        if (sum2) sum2.textContent = strings.howToSummary;
        const div = details[1].querySelector('div');
        if (div) {
          // Wrap the help text in a paragraph for consistent styling
          div.innerHTML = '<p>' + strings.howToText + '</p>';
        }
      }
    }
    // Footer text
    const footerP = document.querySelector('.footer p');
    if (footerP) footerP.textContent = strings.footer;
  }

  // Every category is rendered as a set of checkboxes. The original
  // Swing Tag Builder supported different UI widgets (dropdowns,
  // radios, etc.), but for simplicity and flexibility we ignore
  // those definitions here. This means visitors can select multiple
  // options per category. See renderGroup() for details.

  // Tags grouped by type. Each entry has at minimum a 'tag' field and
  // one or more 'display_xx' fields for different languages. Only
  // active tags are included.
  const tagsByType = {
    "footwear": [
      { "tag": "sneakers-ok", "display_de": "Sneaker erlaubt", "display_en": "Sneakers OK" },
      { "tag": "leather-soles", "display_de": "Ledersohlen", "display_en": "Leather Soles" },
      { "tag": "no-heels", "display_de": "Keine Abs√§tze", "display_en": "No Heels" },
      { "tag": "street-shoes-ok", "display_de": "Stra√üenschuhe erlaubt", "display_en": "Street Shoes OK" }
    ],
    "event_type": [
      { "tag": "class", "display_de": "Kursstunde", "display_en": "Class" },
      { "tag": "course", "display_de": "Kurs (Serie)", "display_en": "Course" },
      { "tag": "workshop", "display_de": "Workshop", "display_en": "Workshop" },
      { "tag": "intensive", "display_de": "Intensivkurs", "display_en": "Intensive" },
      { "tag": "taster", "display_de": "Schnupperkurs", "display_en": "Taster" },
      { "tag": "practice", "display_de": "√úbungsabend", "display_en": "Practice" },
      { "tag": "social", "display_de": "Social Dance", "display_en": "Social" },
      { "tag": "party", "display_de": "Party", "display_en": "Party" },
      { "tag": "live-music", "display_de": "Livemusik", "display_en": "Live Music" },
      { "tag": "band-night", "display_de": "Band-Nacht", "display_en": "Band Night" },
      { "tag": "festival", "display_de": "Festival", "display_en": "Festival" },
      { "tag": "exchange", "display_de": "Exchange", "display_en": "Exchange" },
      { "tag": "competition", "display_de": "Wettbewerb", "display_en": "Competition" },
      { "tag": "performance", "display_de": "Performance", "display_en": "Performance" },
      { "tag": "lecture", "display_de": "Vortrag", "display_en": "Lecture" }
    ],
    "music_speed": [
      { "tag": "slow", "display_de": "Langsam", "display_en": "Slow" },
      { "tag": "medium", "display_de": "Mittel", "display_en": "Medium" },
      { "tag": "fast", "display_de": "Schnell", "display_en": "Fast" },
      { "tag": "very-fast", "display_de": "Sehr schnell", "display_en": "Very Fast" },
      { "tag": "bpm-80-110", "display_de": "BPM 80‚Äì110", "display_en": "BPM 80‚Äì110" },
      { "tag": "bpm-110-140", "display_de": "BPM 110‚Äì140", "display_en": "BPM 110‚Äì140" },
      { "tag": "bpm-140-170", "display_de": "BPM 140‚Äì170", "display_en": "BPM 140‚Äì170" },
      { "tag": "bpm-170-plus", "display_de": "BPM 170+", "display_en": "BPM 170+" }
    ],
    "role": [
      { "tag": "leader", "display_de": "Leader", "display_en": "Leader" },
      { "tag": "follower", "display_de": "Follower", "display_en": "Follower" },
      { "tag": "switch", "display_de": "Switch", "display_en": "Switch" },
      { "tag": "forced-switch", "display_de": "Switch (vorgegeben)", "display_en": "Forced Switch" }
    ],
    "price_type": [
      { "tag": "free", "display_de": "Kostenlos", "display_en": "Free" },
      { "tag": "donation", "display_de": "Spende", "display_en": "Donation" },
      { "tag": "paid", "display_de": "Beitrag", "display_en": "Paid" },
      { "tag": "sliding-scale", "display_de": "Gleitende Skala", "display_en": "Sliding Scale" }
    ],
    "level": [
      { "tag": "beginner", "display_de": "Anf√§nger", "display_en": "Beginner" },
      { "tag": "beginner-plus", "display_de": "Anf√§nger+", "display_en": "Beginner+" },
      { "tag": "improver", "display_de": "Improver", "display_en": "Improver" },
      { "tag": "intermediate", "display_de": "Mittelstufe", "display_en": "Intermediate" },
      { "tag": "intermediate-plus", "display_de": "Mittelstufe+", "display_en": "Intermediate+" },
      { "tag": "advanced", "display_de": "Fortgeschritten", "display_en": "Advanced" },
      { "tag": "all-levels", "display_de": "Alle Levels", "display_en": "All Levels" },
      { "tag": "open-level", "display_de": "Offenes Level", "display_en": "Open Level" }
    ],
    "dance_type": [
      { "tag": "lindy-hop", "display_de": "Lindy Hop", "display_en": "Lindy Hop" },
      { "tag": "balboa", "display_de": "Balboa", "display_en": "Balboa" },
      { "tag": "bal-swing", "display_de": "Bal-Swing", "display_en": "Bal Swing" },
      { "tag": "collegiate-shag", "display_de": "Collegiate Shag", "display_en": "Collegiate Shag" },
      { "tag": "st-louis-shag", "display_de": "St. Louis Shag", "display_en": "St Louis Shag" },
      { "tag": "charleston", "display_de": "Charleston", "display_en": "Charleston" },
      { "tag": "solo-jazz", "display_de": "Solo Jazz", "display_en": "Solo Jazz" },
      { "tag": "jazz-roots", "display_de": "Jazz Roots", "display_en": "Jazz Roots" },
      { "tag": "east-coast-swing", "display_de": "East Coast Swing", "display_en": "East Coast Swing" },
      { "tag": "west-coast-swing", "display_de": "West Coast Swing", "display_en": "West Coast Swing" },
      { "tag": "boogie-woogie", "display_de": "Boogie Woogie", "display_en": "Boogie Woogie" },
      { "tag": "blues", "display_de": "Blues", "display_en": "Blues" },
      { "tag": "shag", "display_de": "Shag", "display_en": "Shag" },
      { "tag": "jitterbug", "display_de": "Jitterbug", "display_en": "Jitterbug" },
      { "tag": "rock-n-roll", "display_de": "Rock ‚Äôn‚Äô Roll", "display_en": "Rock ‚Äôn‚Äô Roll" }
    ],
    "language": [
      { "tag": "german", "display_de": "Deutsch", "display_en": "German" },
      { "tag": "english", "display_de": "Englisch", "display_en": "English" },
      { "tag": "bilingual", "display_de": "Zweisprachig", "display_en": "Bilingual" },
      { "tag": "all-welcome", "display_de": "Alle willkommen", "display_en": "All Welcome" }
    ],
    "venue_type": [
      { "tag": "studio", "display_de": "Studio", "display_en": "Studio" },
      { "tag": "bar", "display_de": "Bar", "display_en": "Bar" },
      { "tag": "club", "display_de": "Club", "display_en": "Club" },
      { "tag": "outdoors", "display_de": "Drau√üen", "display_en": "Outdoors" },
      { "tag": "community-center", "display_de": "Gemeindezentrum", "display_en": "Community Center" },
      { "tag": "theater", "display_de": "Theater", "display_en": "Theater" },
      { "tag": "university", "display_de": "Universit√§t", "display_en": "University" },
      { "tag": "others", "display_de": "Sonstiges", "display_en": "Others" }
    ],
    "age_policy": [
      { "tag": "all-ages", "display_de": "Alle Altersgruppen", "display_en": "All Ages" },
      { "tag": "children-only", "display_de": "Nur Kinder", "display_en": "Children Only" },
      { "tag": "16-plus", "display_de": "Ab 16", "display_en": "16+" },
      { "tag": "18-plus", "display_de": "Ab 18", "display_en": "18+" },
      { "tag": "family-friendly", "display_de": "Familienfreundlich", "display_en": "Family Friendly" }
    ],
    "location": [
      { "tag": "weimar", "display_de": "Weimar", "display_en": "Weimar" },
      { "tag": "erfurt", "display_de": "Erfurt", "display_en": "Erfurt" },
      { "tag": "jena", "display_de": "Jena", "display_en": "Jena" }
    ],
    "music_source": [
      { "tag": "live", "display_de": "Live", "display_en": "Live" },
      { "tag": "dj", "display_de": "DJ", "display_en": "Dj" },
      { "tag": "live-and-dj", "display_de": "Live & DJ", "display_en": "Live & DJ" }
    ],
    "registration": [
      { "tag": "drop-in", "display_de": "Ohne Anmeldung", "display_en": "Drop-in" },
      { "tag": "registration-required", "display_de": "Anmeldung erforderlich", "display_en": "Registration Required" },
      { "tag": "partner-required", "display_de": "Partner*in erforderlich", "display_en": "Partner Required" },
      { "tag": "partner-optional", "display_de": "Partner*in optional", "display_en": "Partner Optional" },
      { "tag": "membership-only", "display_de": "Nur Mitglieder", "display_en": "Membership Only" }
    ]
  };

  // Note: We intentionally omit normalising UI types since every group
  // is rendered as a multi‚Äëselect checkbox list. See renderGroup().

  // State holds the currently selected tags for each type. Values are sets
  // to easily add/remove selections.
  const state = {};

  // Determine available languages by inspecting display_ prefixes.
  const languages = (() => {
    const langs = new Set();
    for (const type in tagsByType) {
      tagsByType[type].forEach(item => {
        Object.keys(item).forEach(key => {
          const m = key.match(/^display_(.+)$/);
          if (m) langs.add(m[1]);
        });
      });
    }
    return Array.from(langs);
  })();

  // Populate the language selector and wire up change handler.  When the
  // selected language changes we update static text and re-render the groups.
  function initLanguages() {
    const sel = document.getElementById('lang');
    // Clear any existing options
    sel.innerHTML = '';
    languages.forEach(lang => {
      const opt = document.createElement('option');
      opt.value = lang;
      opt.textContent = lang;
      sel.appendChild(opt);
    });
    // Try to default to browser language if available
    const browserLang = (navigator.language || 'en').slice(0, 2);
    if (languages.includes(browserLang)) sel.value = browserLang;
    else if (languages.includes('en')) sel.value = 'en';
    sel.addEventListener('change', () => {
      updateStaticText();
      rerenderAll();
    });
  }

  // Build the UI groups based on tagsByType and ui definitions. This is
  // called whenever the language changes or the UI needs to be
  // refreshed. It clears any existing groups and reconstructs the
  // controls.
  function rerenderAll() {
    const container = document.getElementById('groups');
    container.innerHTML = '';
    for (const type of Object.keys(tagsByType).sort()) {
      renderGroup(type);
    }
    updateFeedUrl();
  }

  // Render a single group of tags.
  function renderGroup(type) {
    const groupEl = document.createElement('div');
    groupEl.className = 'group';
    // Create a header row with the type label and select/clear buttons
    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.style.alignItems = 'center';
    const title = document.createElement('h3');
    title.style.marginRight = '8px';
    // Use translated display name for the group if available
    const lang = document.getElementById('lang').value || languages[0];
    const nameMap = typeDisplay[type] || {};
    const label = nameMap[lang] || nameMap['en'] || type;
    title.textContent = label;
    // Buttons wrapper
    const btnWrap = document.createElement('div');
    btnWrap.style.display = 'flex';
    btnWrap.style.gap = '6px';
    const selAll = document.createElement('button');
    // Translate the "All" button label
    selAll.textContent = (uiStrings[lang] && uiStrings[lang].all) || 'All';
    selAll.addEventListener('click', () => {
      // Select all tags for this type
      state[type] = new Set((tagsByType[type] || []).map(item => item.tag));
      rerenderAll();
    });
    const clrAll = document.createElement('button');
    // Translate the "None" button label
    clrAll.textContent = (uiStrings[lang] && uiStrings[lang].none) || 'None';
    clrAll.addEventListener('click', () => {
      // Deselect all tags for this type
      state[type] = new Set();
      rerenderAll();
    });
    btnWrap.appendChild(selAll);
    btnWrap.appendChild(clrAll);
    header.appendChild(title);
    header.appendChild(btnWrap);
    groupEl.appendChild(header);
    // Determine language and items
    const lang = document.getElementById('lang').value || languages[0];
    const items = tagsByType[type] || [];
    if (!state[type]) state[type] = new Set();
    // Render all tags as checkboxes
    items.forEach(item => {
      const lab = document.createElement('label');
      lab.style.display = 'block';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.value = item.tag;
      input.checked = state[type].has(item.tag);
      input.addEventListener('change', () => {
        if (input.checked) state[type].add(item.tag);
        else state[type].delete(item.tag);
        updateFeedUrl();
      });
      lab.appendChild(input);
      const span = document.createElement('span');
      span.textContent = ' ' + (item[`display_${lang}`] || item.tag);
      lab.appendChild(span);
      groupEl.appendChild(lab);
    });
    document.getElementById('groups').appendChild(groupEl);
  }

  // Build query string from state and update the feedUrl input
  function updateFeedUrl() {
    const parts = [];
    for (const type of Object.keys(state)) {
      const values = Array.from(state[type]);
      if (values.length) {
        const encoded = values.map(v => encodeURIComponent(v)).join(',');
        parts.push(`${encodeURIComponent(type)}=${encoded}`);
      }
    }
    const query = parts.join('&');
    const url = parts.length ? `${BASE_URL}?${query}` : BASE_URL;
    document.getElementById('feedUrl').value = url;
  }

  // Copy the current feed URL to the clipboard
  async function copyLinkToClipboard() {
    const el = document.getElementById('feedUrl');
    el.select();
    el.setSelectionRange(0, 99999);
    try {
      await navigator.clipboard.writeText(el.value);
    } catch (err) {
      // fallback: try to exec command
      document.execCommand('copy');
    }
  }

  // Clear all selections and rebuild UI
  function clearAllSelections() {
    for (const type in state) {
      state[type].clear();
    }
    rerenderAll();
    document.getElementById('feedUrl').value = BASE_URL;
  }

  // Attach control handlers
  document.getElementById('copyLink').addEventListener('click', copyLinkToClipboard);
  document.getElementById('clearAll').addEventListener('click', clearAllSelections);

  // Initialise everything on page load.  First fetch the tag UI labels
  // from our CSV, then set up the language selector, static text and
  // initial render.  If the CSV fails to load we still proceed with
  // default labels.
  (async () => {
    await loadTypeDisplay();
    initLanguages();
    updateStaticText();
    rerenderAll();
  })();
  </script>
</body>
</html>